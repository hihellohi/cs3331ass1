\documentclass[a4paper]{article}

\usepackage[english]{babel}
\usepackage[UKenglish]{isodate}
\usepackage[parfill]{parskip}
\usepackage{float}
\usepackage{graphicx}
\usepackage{booktabs}
\usepackage{csquotes}
\usepackage{listings}
\usepackage[margin=2.5cm]{geometry}
\usepackage{enumerate}
\usepackage{siunitx}
\usepackage{appendix}

\newcommand{\nth}{\textsuperscript}

\title{Assignment 1 Report}
\author{Kevin Zihong Ni\\\texttt{z5025098}}

\begin{document}

\maketitle

\section{Design Overview}

Both the sender and the receiver of my implementation of STP was written in C++ (as authorised by the lecturer Apro S. Kanhere
over email). I chose to do this as C++, unlike C offers the standard template library, allowing the use of data structures such as
maps and queues which would have required significant amounts of time investment to implement on my own. The code does 
\textbf{not} require a C++11 compiler.

\subsection{Sender}
The sender keeps a queue of segments that have been sent but have yet to be acked. This queue is never greater than the maximum
window size and is "replenished" from the input file whenever its size falls below the maximum (unless the EOF has been reached).
Whenever an ack is received, segments are popped off the front of the queue until the sequence number of the
next packet is no longer greater than the ack number of the received acknowledgement. If the ack number is equal to the segment
at the front of the queue (before any popping), the duplicate ack counter is incremented. When this counter reaches 3, or if the
timeout period expires, the packet at the front of the queue is retransmitted.

\subsection{Receiver}
The receiver continuously listens for incoming data on the given socket. It keeps track of the lowest sequence number that it has
yet to receive. An acknowledgment packet with this number is sent every time a data packet is received.
If a received packet has sequence number less than this number, it just throws it away as it already has that
data, making it a duplicate. If it is greater, then it caches the packet into a map, indexing it by its sequence number.
if it is equal to the number, then it increments the number by the length of the received packet and searches the map
for a packet that has a sequence number equal to the new number. It repeats this until no such packet exists in the map.

\subsection{Extension}
The delay module of the extension was implemented with the use of a min priority queue. Whenever a packet was delayed, it was 
pushed onto the priority queue with the current time in milliseconds plus a random constant. Whenever the current time was greater
than the priority of the next item of the priority queue, the item was sent and popped off the priority queue.

The estimation module of the extension was implemented using a map. Whenever a segment was "sent", its sequence number and a 
timestamp was recorded into a map. If a retransmission occured, a flag was set that would only be reset on a successful ack.
If the flag was not set, then the current time was used to recalculate the estimations whenever an acknowledgment was received.

\subsection{Features}
The list of successfully implemented features is as follows:
\begin{itemize}
	\item Successful reliable transmission of a file.
	\item Three way handshake (SYN, SYNACK, ACK) to establish connection. It is assumed that this is always received by the
		receiver (as per the specifications). This \textbf{can} be delayed.
	\item Randomized starting sequence number. Can handle integer overflows. Greater than and less than defined by window size.
	\item Four way termination (FIN, ACK, FIN, ACK). The middle two packets were combined into one (as per the example given in
		the specifications). Like the handshake packets, these may be delayed but never dropped.
	\item Single timer for timeout operation for sender.
	\item Fast retransmit after 3 duplicate acks.
	\item Both sequence number and acknowledgement number included in header.
	\item Sender takes in maximum segment size and maximum window size as input.
	\item PLD module randomly drops and delays packets with chances and maximum delay given as input.
	\item Dynamic timeout calculated from sample RTTs. (This has a floor of 1ms because 0ms resulted in timeouts happening
		constantly resulting in significant amounts of natural packet loss due to the sheer volume of UDP datagrams being sent)
\end{itemize}

\section{STP Header}
\lstinputlisting[language=C, caption=STP Header Struct Definition]{header.h}
\begin{table}[H]
\centering
\caption{STP Header Field Descriptions}
\label{header}
\begin{tabular}{@{}llp{0.8\textwidth}@{}}
\toprule
Field & Bytes & Description \\ \midrule
\verb|n_seq| & 4 & Contains the sequence number  of the segment. Byte-stream oriented, meaning that the sequence number reflects the index of the first data byte instead of the index of the packet. \\
\verb|n_ack| & 4 & Contains the acknowledgement number when sending an acknowledgement packet. Is also used to communicate the maximum segment size during the handshake. \\
\verb|len| & 4 & The length of the data packet (excluding header) in bytes. \\
\verb|size| & 4 & Only used during handshake. Contains the size of the window in bytes (necessary to handle sequence number overflows). \\
\verb|flags| & 1 & Indicates whether the segment is a SYN, FIN, ACK and/or DATA segment. \\ \bottomrule
\end{tabular}
\end{table}

\section{Extension Questions}
\subsection{Experiment A}
The results of this experiment are in appendix \ref{expa}.

If a packet arrives out of order, it has been previously dropped and needed to be retransmitted.
Consequently the packet sequence of the first experiment seems to be more in-order than the second
due to its lower drop rate.

examples of dropped packets (in the first experiment) are:
\begin{itemize}
	\item 677741241
	\item 677742041	
	\item 677742391
\end{itemize}

\appendix

\section{Results for Experiment A} \label{expa}

\subsection {\texttt{pdrop} = 0.1}
\begin{lstlisting}
action	time	flags	n_seq		len	n_ack
rcv	60699	S	677741240	0	50
rcv	60725	A	677741241	0	1745463638
rcv	60773	D	677741291	50	1745463638
rcv	60788	D	677741341	50	1745463638
rcv	60792	D	677741391	50	1745463638
rcv	60792	D	677741441	50	1745463638
rcv	60792	D	677741491	50	1745463638
rcv	60793	D	677741541	50	1745463638
rcv	60793	D	677741591	50	1745463638
rcv	60793	D	677741641	50	1745463638
rcv	60793	D	677741691	50	1745463638
rcv	60793	D	677741241	50	1745463638
rcv	60814	D	677741741	50	1745463638
rcv	60814	D	677741791	50	1745463638
rcv	60815	D	677741841	50	1745463638
rcv	60815	D	677741941	50	1745463638
rcv	60815	D	677741991	50	1745463638
rcv	60815	D	677742091	50	1745463638
rcv	60815	D	677742141	50	1745463638
rcv	60815	D	677742191	50	1745463638
rcv	60818	D	677742241	50	1745463638
rcv	60818	D	677742291	50	1745463638
rcv	60818	D	677742341	50	1745463638
rcv	60818	D	677741891	50	1745463638
rcv	60818	D	677742441	50	1745463638
rcv	60819	D	677742491	50	1745463638
rcv	61186	D	677742041	50	1745463638
rcv	61187	D	677742541	50	1745463638
rcv	61187	D	677742591	50	1745463638
rcv	61187	D	677742641	50	1745463638
rcv	61187	D	677742691	50	1745463638
rcv	61187	D	677742741	50	1745463638
rcv	61188	D	677742791	43	1745463638
rcv	61188	D	677742391	50	1745463638
rcv	61193	F	677742834	0	1745463638
rcv	61197	A	677742835	0	1745463639
\end{lstlisting}

\subsection {\texttt{pdrop} = 0.3}
\begin{lstlisting}
action	time	flags	n_seq		len	n_ack
rcv	6000	S	677741240	0	50
rcv	6027	A	677741241	0	2092840949
rcv	6074	D	677741291	50	2092840949
rcv	6089	D	677741341	50	2092840949
rcv	6093	D	677741391	50	2092840949
rcv	6094	D	677741441	50	2092840949
rcv	6094	D	677741491	50	2092840949
rcv	6094	D	677741591	50	2092840949
rcv	6094	D	677741641	50	2092840949
rcv	6094	D	677741691	50	2092840949
rcv	6094	D	677741241	50	2092840949
rcv	6116	D	677741741	50	2092840949
rcv	6116	D	677741791	50	2092840949
rcv	6116	D	677741841	50	2092840949
rcv	6116	D	677741891	50	2092840949
rcv	6116	D	677741941	50	2092840949
rcv	6116	D	677741991	50	2092840949
rcv	6272	D	677741541	50	2092840949
rcv	6275	D	677742041	50	2092840949
rcv	6275	D	677742091	50	2092840949
rcv	6275	D	677742141	50	2092840949
rcv	6275	D	677742191	50	2092840949
rcv	6275	D	677742241	50	2092840949
rcv	6275	D	677742341	50	2092840949
rcv	6275	D	677742391	50	2092840949
rcv	6275	D	677742441	50	2092840949
rcv	6278	D	677742541	50	2092840949
rcv	6278	D	677742591	50	2092840949
rcv	6278	D	677742641	50	2092840949
rcv	6384	D	677742291	50	2092840949
rcv	6387	D	677742791	43	2092840949
rcv	6490	D	677742491	50	2092840949
rcv	6597	D	677742691	50	2092840949
rcv	6702	D	677742741	50	2092840949
rcv	6708	F	677742834	0	2092840949
rcv	6712	A	677742835	0	2092840950
\end{lstlisting}

\end{document}
